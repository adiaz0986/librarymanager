<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Libros - Library Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: rgba(0,0,0,0.1);}
        .navbar { background-color: #242525; }
        .navbar-brand, .logout { color: #fff !important; }
        .card { border-radius: 12px; }
        .sidebar { background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%); min-height: calc(100vh - 56px); }
        .sidebar a { color: #ecf0f1; text-decoration: none; padding: 12px 20px; display: block; }
        .sidebar a:hover, .sidebar a.active { background-color: rgba(52, 152, 219, 0.3); }
        .badge { font-size: 0.85rem; }
        .table-hover tbody tr:hover { background-color: #f1f3f5; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg px-4">
    <span class="navbar-brand">Library Manager</span>
    <div class="ms-auto">
        <button class="btn btn-sm btn-danger logout" onclick="logout()">Salir</button>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2 px-0 sidebar">
            <div class="pt-3">
                <a href="/"><i class="bi bi-house-door me-2"></i>Dashboard</a>
                <a href="/books" class="active"><i class="bi bi-book me-2"></i>Libros</a>
                <a href="/loans"><i class="bi bi-arrow-left-right me-2"></i>Préstamos</a>
            </div>
        </div>

        <!-- Contenido principal -->
        <div class="col-md-10 p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3><i class="bi bi-book"></i> Gestión de Libros</h3>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bookModal" onclick="openBookModal()">
                    <i class="bi bi-plus-circle"></i> Nuevo Libro
                </button>
            </div>

            <!-- Buscador -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" 
                               placeholder="Buscar por título, autor o ISBN..." 
                               onkeyup="searchBooks()">
                    </div>
                </div>
            </div>

            <!-- Tabla de libros -->
            <div class="card">
                <div class="card-body">
                    <div id="loadingSpinner" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                    
                    <div id="booksTableContainer" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>ISBN</th>
                                        <th>Título</th>
                                        <th>Autor</th>
                                        <th>Año</th>
                                        <th>Estado</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="booksTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="emptyState" style="display: none;" class="text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
                        <p class="text-muted mt-3">No hay libros registrados</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bookModal" onclick="openBookModal()">
                            <i class="bi bi-plus-circle"></i> Agregar primer libro
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear/editar libro -->
<div class="modal fade" id="bookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookModalTitle">Nuevo Libro</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bookForm">
                    <input type="hidden" id="bookId">
                    
                    <div class="mb-3">
                        <label for="title" class="form-label">Título *</label>
                        <input type="text" class="form-control" id="title" required>
                    </div>

                    <div class="mb-3">
                        <label for="author" class="form-label">Autor *</label>
                        <input type="text" class="form-control" id="author" required>
                    </div>

                    <div class="mb-3">
                        <label for="isbn" class="form-label">ISBN (13 dígitos) *</label>
                        <input type="text" class="form-control" id="isbn" 
                               pattern="[0-9]{13}" maxlength="13" required>
                        <small class="text-muted">Ejemplo: 9781234567890</small>
                    </div>

                    <div class="mb-3">
                        <label for="publicationYear" class="form-label">Año de Publicación *</label>
                        <input type="number" class="form-control" id="publicationYear" 
                               min="1000" max="2026" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveBook()">
                    <i class="bi bi-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast para notificaciones -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
    <div id="toast" class="toast align-items-center border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="toastMessage"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let allBooks = [];
let editingBookId = null;

// ===== FUNCIONES DE AUTENTICACIÓN =====
function logout() {
    localStorage.removeItem("token");
    window.location.href = "/login";
}

const token = localStorage.getItem("token");
if (!token || token.trim() === "") {
    console.warn("No se encontró token válido. Redirigiendo al login...");
    logout();
}

// ===== CARGAR LIBROS AL INICIAR =====
document.addEventListener('DOMContentLoaded', function() {
    loadBooks();
});

// ===== CARGAR LIBROS DESDE LA API =====
async function loadBooks() {
    try {
        const response = await fetch('/api/books', {
            headers: { 'Authorization': 'Bearer ' + token }
        });

        if (!response.ok) {
            if (response.status === 401) {
                console.warn("Token inválido o expirado. Haciendo logout...");
                logout();
                return;
            }
            throw new Error('Error al cargar libros');
        }

        const responseData = await response.json();
        allBooks = responseData.data || responseData;
        renderBooks(allBooks);
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error al cargar los libros', 'danger');
    }
}

// ===== RENDERIZAR LIBROS EN LA TABLA =====
function renderBooks(books) {
    const tbody = document.getElementById('booksTableBody');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const tableContainer = document.getElementById('booksTableContainer');
    const emptyState = document.getElementById('emptyState');

    loadingSpinner.style.display = 'none';

    if (books.length === 0) {
        tableContainer.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }

    emptyState.style.display = 'none';
    tableContainer.style.display = 'block';

    tbody.innerHTML = books.map(book => `
        <tr>
            <td><code>${book.isbn}</code></td>
            <td><strong>${book.title}</strong></td>
            <td>${book.author}</td>
            <td>${book.publicationYear}</td>
            <td>${getStatusBadge(book.status)}</td>
            <td class="text-center">
                <button class="btn btn-sm btn-outline-primary me-1" 
                        onclick="editBook(${book.id})"
                        title="Editar">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" 
                        onclick="deleteBook(${book.id})"
                        ${book.status !== 'AVAILABLE' ? 'disabled' : ''}
                        title="${book.status !== 'AVAILABLE' ? 'No se puede eliminar (prestado)' : 'Eliminar'}">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

// ===== OBTENER BADGE DE ESTADO =====
function getStatusBadge(status) {
    const badges = {
        'AVAILABLE': '<span class="badge bg-success">Disponible</span>',
        'BORROWED': '<span class="badge bg-warning text-dark">Prestado</span>',
        'RESERVED': '<span class="badge bg-info">Reservado</span>'
    };
    return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
}

// ===== BUSCAR LIBROS =====
function searchBooks() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    
    if (!query) {
        renderBooks(allBooks);
        return;
    }

    const filtered = allBooks.filter(book => 
        book.title.toLowerCase().includes(query) ||
        book.author.toLowerCase().includes(query) ||
        book.isbn.includes(query)
    );

    renderBooks(filtered);
}

// ===== ABRIR MODAL PARA CREAR/EDITAR =====
function openBookModal(bookId = null) {
    editingBookId = bookId;
    const modal = document.getElementById('bookModal');
    const title = document.getElementById('bookModalTitle');
    const form = document.getElementById('bookForm');
    
    form.reset();

    if (bookId) {
        title.textContent = 'Editar Libro';
        const book = allBooks.find(b => b.id === bookId);
        if (book) {
            document.getElementById('bookId').value = book.id;
            document.getElementById('title').value = book.title;
            document.getElementById('author').value = book.author;
            document.getElementById('isbn').value = book.isbn;
            document.getElementById('publicationYear').value = book.publicationYear;
            document.getElementById('isbn').readOnly = true;
        }
    } else {
        title.textContent = 'Nuevo Libro';
        document.getElementById('isbn').readOnly = false;
    }
}

// ===== EDITAR LIBRO =====
function editBook(bookId) {
    openBookModal(bookId);
    const modal = new bootstrap.Modal(document.getElementById('bookModal'));
    modal.show();
}

// ===== GUARDAR LIBRO (CREAR O ACTUALIZAR) =====
async function saveBook() {
    const form = document.getElementById('bookForm');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const book = {
        title: document.getElementById('title').value,
        author: document.getElementById('author').value,
        isbn: document.getElementById('isbn').value,
        publicationYear: parseInt(document.getElementById('publicationYear').value)
    };

    try {
        const url = editingBookId ? `/api/books/${editingBookId}` : '/api/books';
        const method = editingBookId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(book)
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('bookModal')).hide();
            showAlert(`Libro ${editingBookId ? 'actualizado' : 'creado'} exitosamente`, 'success');
            loadBooks();
        } else {
            const errorData = await response.json();
            const errorMessage = errorData.message || errorData.error || 'Error al guardar el libro';
            showAlert(errorMessage, 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error al guardar el libro', 'danger');
    }
}

// ===== ELIMINAR LIBRO =====
async function deleteBook(bookId) {
    if (!confirm('¿Está seguro de eliminar este libro?')) {
        return;
    }

    try {
        const response = await fetch(`/api/books/${bookId}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
        });

        if (response.ok) {
            showAlert('Libro eliminado exitosamente', 'success');
            loadBooks();
        } else {
            const errorData = await response.json();
            const errorMessage = errorData.message || errorData.error || 'Error al eliminar el libro';
            showAlert(errorMessage, 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error al eliminar el libro', 'danger');
    }
}

// ===== MOSTRAR ALERTAS =====
function showAlert(message, type) {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    
    toast.className = `toast align-items-center border-0 text-white bg-${type}`;
    toastMessage.textContent = message;
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}
</script>

</body>
</html>